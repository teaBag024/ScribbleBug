{% extends "base.html" %}

{% load static %}
{% block title %}New Scribble{% endblock %}
{% block content %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'scribblebug/styles.css' %}">
{% endblock %}

    <div id="app">
    {% csrf_token %}


        <div class="container title-container">
                <keyword-selector></keyword-selector>

        </div>

    </div>




    <style>
/* Container */
.keyword-selector {
    max-width: 600px;
    margin: 0px auto;
}

/* Selected tags */
.selected-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
}

.tag {
    background: #6366f1;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tag button {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 0;
    line-height: 1;
    opacity: 0.8;
}

.tag button:hover {
    opacity: 1;
}

/* Input */
.keyword-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s;

}

.keyword-input:focus {
    outline: none;
    border-color: #6366f1;
}

/* Suggestions */
.suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.suggestion-btn {
    background: #f3f4f6;
    border: none;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    color: #374151;
    transition: background 0.2s;

    vertical-align: bottom;
}

.suggestion-btn:hover {
    background: #e5e7eb;
}

.chip-container{
    height: 10vh;
    display: flex;
    gap: 20px;
    align-items: flex-start;
}

</style>
    <script type="module">
        import { createApp } from 'vue';

        // Keyword Selector Component
        const SelectorComponent = {
            delimiters: ['[[', ']]'],
            // language=Vue
            template: `
                <div class="keyword-selector col-12">
                    <div class="welcome-card" style="margin-top: 25vh">
                      I am thinking of...
                    </div>
                    <div class="chip-container col-12">
                        <div v-if="selected.length" class="selected-tags">
                            <span v-for="vibe in selected" :key="vibe" class="tag">
                                [[ vibe ]] <button @click="remove(vibe)">Ã—</button>
                            </span>
                        </div>
                        <div v-if="input" class="suggestions">
                            <button v-for="vibe in filtered" :key="vibe" @click="addVibe(vibe)" class="suggestion-btn">
                                [[ vibe ]]
                            </button>
                        </div>
                    </div>


                    <input v-model="input" @keydown.enter="add" placeholder="Type to search or add..." class="keyword-input">

                    <br>
                    <br>

                    <button @click="submitForm" type="button" class="submit-btn btn btn-primary" :disabled="selected.length == 0">
                        Create
                    </button>

                </div>
`,
            data() {
                return {
                    input: '',
                    selected: [],
                    presets: [
                        "games",
                        "kids",
                        "fun",
                        "cool",
                        "play",
                        "free",
                        "puzzle",
                        "adventure",
                        "action",
                        "racing",
                        "platform",
                        "dressup",
                        "building",
                        "strategy",
                        "simulation",
                        "typing",
                        "math",
                        "science",
                        "reading",
                        "learn",
                        "explore",
                        "create",
                        "solve",
                        "collect",
                        "jump",
                        "run",
                        "fly",
                        "drive",
                        "pet",
                        "animal",
                        "dog",
                        "cat",
                        "bird",
                        "fish",
                        "bug",
                        "insect",
                        "spider",
                        "bear",
                        "lion",
                        "frog",
                        "squirrel",
                        "penguin",
                        "monkey",
                        "robot",
                        "alien",
                        "knight",
                        "princess",
                        "pirate",
                        "hero",
                        "wizard",
                        "witch",
                        "fairy",
                        "chef",
                        "doctor",
                        "farmer",
                        "rainforest",
                        "ocean",
                        "space",
                        "city",
                        "farm",
                        "jungle",
                        "castle",
                        "island",
                        "desert",
                        "arctic",
                        "cowboy",
                        "western",
                        "beach",
                        "mine",
                        "garden",
                        "forest",
                        "chill",
                        "calm",
                        "relax",
                        "intense",
                        "fast",
                        "quick",
                        "puzzling",
                        "clever",
                        "tricky",
                        "easy",
                        "hard",
                        "happy",
                        "funny",
                        "silly",
                        "cute",
                        "crafty",
                        "decor",
                        "story",
                        "music",
                        "art",
                        "color",
                        "paint",
                        "word",
                        "number",
                        "memory",
                        "snake",
                        "minesweeper",
                        "solo",
                        "single",
                        "tap",
                        "swipe",
                        "match"
                    ]
                }
            },
            computed: {
                filtered() {
                    const allowed_len = 5 - this.selected.length;
                    return (this.presets.filter(v =>
                        v.toLowerCase().includes(this.input.toLowerCase()) &&
                        !this.selected.includes(v)).slice(0, allowed_len)
                    )
                }
            },
            methods: {
                add() {
                    const value = this.input.trim();
                    if (!value) return;

                    // Add first filtered match, or create custom
                    const toAdd = this.filtered.length > 0 ? this.filtered[0] : value;

                    if (!this.selected.includes(toAdd)) {
                        this.selected.push(toAdd);
                        this.input = '';
                    }
                },
                addVibe(vibe) {
                    if (!this.selected.includes(vibe) && this.selected.length <=5) {
                        this.selected.push(vibe);
                        this.input = '';
                    }
                },
                remove(vibe) {
                    this.selected = this.selected.filter(v => v !== vibe);
                },
        async submitForm() {
            if (this.selected.length === 0) return;

            this.loading = true;
            this.statusMessage = 'Starting...';

            const response = await fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ keywords: this.selected })
            });
             const data = await response.json();

            if (response.ok) {
                this.listenForUpdates(data.task_id);
            } else {
                alert('Error: ' + (data.error || 'Something went wrong'));
                this.loading = false;
            }
            },
        listenForUpdates(taskId) {
            const eventSource = new EventSource(`/task-stream/${taskId}/`);

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.status === 'processing') {
                    this.statusMessage = data.message || 'Processing...';
                } else if (data.status === 'complete') {
                    eventSource.close();
                    window.location.href = data.redirect_url;
                } else if (data.status === 'failed') {
                    eventSource.close();
                    alert('Processing failed');
                    this.loading = false;
                }
            };

            eventSource.onerror = () => {
                eventSource.close();
                alert('Connection lost');
                this.loading = false;
            };
        }
            }
        };

        // Create Vue app
        createApp({
            components: {
                'keyword-selector': SelectorComponent,
            }
        }).mount('#app');
    </script>
{% endblock %}