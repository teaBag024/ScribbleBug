{% extends "base.html" %}

{% load static %}
{% block title %}New Scribble{% endblock %}
{% block content %}
{% block extra_css %}
    <link rel="stylesheet" href="{% static 'scribblebug/styles.css' %}">
{% endblock %}

    <div id="app">
    {% csrf_token %}


        <div class="container title-container">
            <div class = "row">
                <div class="col-12">
                    <div class="welcome-card">
                    I am thinking of...
                    </div>
                </div>
                <keyword-selector></keyword-selector>
            </div>

        </div>

    </div>




    <style>
/* Container */
.keyword-selector {
    max-width: 600px;
    margin: 0 auto;
}

/* Selected tags */
.selected-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
}

.tag {
    background: #6366f1;
    color: white;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.tag button {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 0;
    line-height: 1;
    opacity: 0.8;
}

.tag button:hover {
    opacity: 1;
}

/* Input */
.keyword-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.keyword-input:focus {
    outline: none;
    border-color: #6366f1;
}

/* Suggestions */
.suggestions {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 12px;
}

.suggestion-btn {
    background: #f3f4f6;
    border: none;
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    color: #374151;
    transition: background 0.2s;
}

.suggestion-btn:hover {
    background: #e5e7eb;
}
</style>
    <script type="module">
        import { createApp } from 'vue';

        // Keyword Selector Component
        const SelectorComponent = {
            delimiters: ['[[', ']]'],
            // language=Vue
            template: `
          <div class="keyword-selector">
            <div v-if="selected.length" class="selected-tags">
              <span v-for="vibe in selected" :key="vibe" class="tag">
                [[ vibe ]] <button @click="remove(vibe)">Ã—</button>
              </span>
            </div>

            <input v-model="input" @keydown.enter="add" placeholder="Type to search or add..." class="keyword-input">

            <div v-if="input" class="suggestions">
              <button v-for="vibe in filtered" :key="vibe" @click="addVibe(vibe)" class="suggestion-btn">
                [[ vibe ]]
              </button>
            </div>

<button @click="submitForm" class="submit-btn" :disabled="selected.length == 0">
            Create Scribble
          </button>
          </div>
        `,
            data() {
                return {
                    input: '',
                    selected: [],
                    presets: ['Chill', 'Energetic', 'Cozy', 'Snake', 'Arcade', 'Spider', 'Insect', 'Cowboy']
                }
            },
            computed: {
                filtered() {
                    return this.presets.filter(v =>
                        v.toLowerCase().includes(this.input.toLowerCase()) &&
                        !this.selected.includes(v)
                    )
                }
            },
            methods: {
                add() {
                    const value = this.input.trim();
                    if (!value) return;

                    // Add first filtered match, or create custom
                    const toAdd = this.filtered.length > 0 ? this.filtered[0] : value;

                    if (!this.selected.includes(toAdd)) {
                        this.selected.push(toAdd);
                        this.input = '';
                    }
                },
                addVibe(vibe) {
                    if (!this.selected.includes(vibe)) {
                        this.selected.push(vibe);
                        this.input = '';
                    }
                },
                remove(vibe) {
                    this.selected = this.selected.filter(v => v !== vibe);
                },
        async submitForm() {
            if (this.selected.length === 0) return;

            this.loading = true;
            this.statusMessage = 'Starting...';

            const response = await fetch('', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({ keywords: this.selected })
            });
             const data = await response.json();

            if (response.ok) {
                this.listenForUpdates(data.task_id);
            } else {
                alert('Error: ' + (data.error || 'Something went wrong'));
                this.loading = false;
            }
            },
        listenForUpdates(taskId) {
            const eventSource = new EventSource(`/task-stream/${taskId}/`);

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                if (data.status === 'processing') {
                    this.statusMessage = data.message || 'Processing...';
                } else if (data.status === 'complete') {
                    eventSource.close();
                    window.location.href = data.redirect_url;
                } else if (data.status === 'failed') {
                    eventSource.close();
                    alert('Processing failed');
                    this.loading = false;
                }
            };

            eventSource.onerror = () => {
                eventSource.close();
                alert('Connection lost');
                this.loading = false;
            };
        }
            }
        };

        // Create Vue app
        createApp({
            components: {
                'keyword-selector': SelectorComponent,
            }
        }).mount('#app');
    </script>

<a role="button">Submit</a>
{% endblock %}